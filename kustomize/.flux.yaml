version: 1
generators: 
  - command: kustomize build .
updaters:
  # use https://github.com/squaremo/kubeyaml on flux-patch.yaml
  - containerImage:
      command: >-
        cat << EOF > ./patches/patch-flux-$FLUX_WL_NAME.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $FLUX_WL_NAME
  namespace: $FLUX_WL_NS
  annotations:
    flux.weave.works/automated: 'true'
spec:
  template:
    spec:
      containers:
      - name: $FLUX_CONTAINER
        image: $FLUX_IMG:$FLUX_TAG

EOF
        kustomize edit add patch patches/*.yaml
